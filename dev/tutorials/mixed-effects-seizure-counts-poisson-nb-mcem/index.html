<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Mixed-Effects Tutorial 5: Seizure Counts with Poisson and NegativeBinomial Outcomes (MCEM) · NoLimits.jl</title><meta name="title" content="Mixed-Effects Tutorial 5: Seizure Counts with Poisson and NegativeBinomial Outcomes (MCEM) · NoLimits.jl"/><meta property="og:title" content="Mixed-Effects Tutorial 5: Seizure Counts with Poisson and NegativeBinomial Outcomes (MCEM) · NoLimits.jl"/><meta property="twitter:title" content="Mixed-Effects Tutorial 5: Seizure Counts with Poisson and NegativeBinomial Outcomes (MCEM) · NoLimits.jl"/><meta name="description" content="Documentation for NoLimits.jl."/><meta property="og:description" content="Documentation for NoLimits.jl."/><meta property="twitter:description" content="Documentation for NoLimits.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="NoLimits.jl logo"/></a><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../installation/">Installation</a></li><li><a class="tocitem" href="../../capabilities/">Capabilities</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Model Building</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../model-building/">Overview</a></li><li><a class="tocitem" href="../../model-building/model-macro/">@Model</a></li><li><a class="tocitem" href="../../model-building/helpers/">@helpers</a></li><li><a class="tocitem" href="../../model-building/fixed-effects/">@fixedEffects</a></li><li><a class="tocitem" href="../../model-building/covariates/">@covariates</a></li><li><a class="tocitem" href="../../model-building/random-effects/">@randomEffects</a></li><li><a class="tocitem" href="../../model-building/pre-differential-equation/">@preDifferentialEquation</a></li><li><a class="tocitem" href="../../model-building/differential-equation/">@DifferentialEquation</a></li><li><a class="tocitem" href="../../model-building/initial-de/">@initialDE</a></li><li><a class="tocitem" href="../../model-building/formulas/">@formulas</a></li><li><a class="tocitem" href="../../model-building/universal-function-approximators/">Function Approximators (NNs + SoftTrees)</a></li></ul></li><li><a class="tocitem" href="../../data-model-construction/">Data Model Construction</a></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Estimation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../estimation/">Overview</a></li><li><a class="tocitem" href="../../estimation/laplace/">Laplace</a></li><li><a class="tocitem" href="../../estimation/laplace-map/">Laplace MAP</a></li><li><a class="tocitem" href="../../estimation/mcem/">MCEM</a></li><li><a class="tocitem" href="../../estimation/saem/">SAEM</a></li><li><a class="tocitem" href="../../estimation/mcmc/">MCMC</a></li><li><a class="tocitem" href="../../estimation/vi/">VI</a></li><li><a class="tocitem" href="../../estimation/mle/">MLE</a></li><li><a class="tocitem" href="../../estimation/mle-map/">MAP</a></li><li><a class="tocitem" href="../../estimation/multistart/">Multistart</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Uncertainty Quantification</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../uncertainty-quantification/">Overview</a></li><li><a class="tocitem" href="../../uncertainty-quantification/wald/">Wald</a></li><li><a class="tocitem" href="../../uncertainty-quantification/profile-likelihood/">Profile likelihood</a></li><li><a class="tocitem" href="../../uncertainty-quantification/mcmc-based-uncertainty/">MCMC-based uncertainty</a></li></ul></li><li><a class="tocitem" href="../../plotting/">Plotting</a></li><li><input class="collapse-toggle" id="menuitem-9" type="checkbox" checked/><label class="tocitem" for="menuitem-9"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../mixed-effects-multiple-methods/">Mixed-Effects Tutorial 1: Nonlinear Random-Effects Model Across Multiple Estimation Methods</a></li><li><a class="tocitem" href="../mixed-effects-ode-mcem/">Mixed-Effects Tutorial 2: ODE Model with Dosing Events (MCEM)</a></li><li><a class="tocitem" href="../mixed-effects-nn-saem/">Mixed-Effects Tutorial 3: Neural Differential-Equation Components (SAEM)</a></li><li><a class="tocitem" href="../mixed-effects-softtree-saem/">Mixed-Effects Tutorial 4: SoftTree Differential-Equation Components (SAEM)</a></li><li class="is-active"><a class="tocitem" href>Mixed-Effects Tutorial 5: Seizure Counts with Poisson and NegativeBinomial Outcomes (MCEM)</a><ul class="internal"><li><a class="tocitem" href="#Learning-Goals"><span>Learning Goals</span></a></li><li><a class="tocitem" href="#Step-1:-Data-Setup"><span>Step 1: Data Setup</span></a></li><li><a class="tocitem" href="#Step-2:-Poisson-Mixed-Effects-Model"><span>Step 2: Poisson Mixed-Effects Model</span></a></li><li><a class="tocitem" href="#Step-3:-Negative-Binomial-Mixed-Effects-Model"><span>Step 3: Negative Binomial Mixed-Effects Model</span></a></li><li><a class="tocitem" href="#Step-4:-Comparing-Poisson-and-Negative-Binomial-Objectives"><span>Step 4: Comparing Poisson and Negative Binomial Objectives</span></a></li></ul></li><li><a class="tocitem" href="../mixed-effects-left-censored-virload50-laplace/">Mixed-Effects Tutorial 6: Left-Censored Nonlinear Model (Laplace)</a></li><li><a class="tocitem" href="../mixed-effects-vi/">Mixed-Effects Tutorial 7: Variational Inference (VI)</a></li><li><a class="tocitem" href="../fixed-effects-nonlinear-mle-map/">Fixed-Effects Tutorial 1: Nonlinear Longitudinal Model (MLE + MAP)</a></li><li><a class="tocitem" href="../fixed-effects-vi/">Fixed-Effects Tutorial 2: Variational Inference (VI)</a></li></ul></li><li><a class="tocitem" href="../../how-to-contribute/">How to Contribute</a></li><li><a class="tocitem" href="../../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Mixed-Effects Tutorial 5: Seizure Counts with Poisson and NegativeBinomial Outcomes (MCEM)</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Mixed-Effects Tutorial 5: Seizure Counts with Poisson and NegativeBinomial Outcomes (MCEM)</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/manuhuth/NoLimits.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/manuhuth/NoLimits.jl/blob/main/docs/src/tutorials/mixed-effects-seizure-counts-poisson-nb-mcem.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Mixed-Effects-Tutorial-5:-Modeling-Seizure-Counts-with-Poisson-and-Negative-Binomial-Outcomes"><a class="docs-heading-anchor" href="#Mixed-Effects-Tutorial-5:-Modeling-Seizure-Counts-with-Poisson-and-Negative-Binomial-Outcomes">Mixed-Effects Tutorial 5: Modeling Seizure Counts with Poisson and Negative Binomial Outcomes</a><a id="Mixed-Effects-Tutorial-5:-Modeling-Seizure-Counts-with-Poisson-and-Negative-Binomial-Outcomes-1"></a><a class="docs-heading-anchor-permalink" href="#Mixed-Effects-Tutorial-5:-Modeling-Seizure-Counts-with-Poisson-and-Negative-Binomial-Outcomes" title="Permalink"></a></h1><p>Counting events over time – seizures, infections, adverse reactions – is one of the most common tasks in longitudinal clinical research. Yet count data behave very differently from continuous measurements. Counts are non-negative integers, their variance typically grows with their mean, and they are often right-skewed. Applying a Normal likelihood to such data can produce negative predicted counts, biased standard errors, and misleading inferences. The Poisson and Negative Binomial distributions are the natural statistical models for these outcomes because they respect the discrete, non-negative nature of counts and link the variance directly to the mean.</p><p>In this tutorial, you will build and compare two nonlinear mixed-effects models for repeated seizure counts, using data from the Thall and Vail (1990) epilepsy trial. This trial is one of the most widely analyzed longitudinal count datasets in biostatistics: 59 epilepsy patients were randomized to either progabide or placebo, and seizure counts were recorded across four consecutive two-week periods following a baseline observation window. The dataset has become a benchmark for count regression methods because it exhibits substantial between-subject variability and overdispersion – features that push simple Poisson models to their limits and motivate the Negative Binomial alternative.</p><p>Both models share the same fixed-effects covariates and subject-level random-effects structure; they differ only in the outcome distribution. The Poisson assumes the variance equals the mean, while the Negative Binomial introduces a dispersion parameter to accommodate extra-Poisson variation. Because the subject-specific random effect enters inside an exponential rate function, both models are nonlinear in the random effects. This nonlinearity means the marginal likelihood integral over random effects has no closed-form solution, making Monte Carlo Expectation-Maximization (MCEM) a natural estimation strategy.</p><h2 id="Learning-Goals"><a class="docs-heading-anchor" href="#Learning-Goals">Learning Goals</a><a id="Learning-Goals-1"></a><a class="docs-heading-anchor-permalink" href="#Learning-Goals" title="Permalink"></a></h2><p>By the end of this tutorial, you will be able to:</p><ul><li><strong>Prepare longitudinal count data</strong> – reshape the classic MASS <code>epil</code> dataset into the long format NoLimits expects, deriving subject-level covariates (baseline seizure rate, age, treatment) and time-varying design variables (period, treatment-by-period interaction).</li><li><strong>Specify count regression models</strong> – define both a Poisson and a Negative Binomial mixed-effects model in NoLimits, each with a log-link linear predictor and a subject-level random intercept.</li><li><strong>Estimate with MCEM</strong> – fit both models using Monte Carlo Expectation-Maximization, an algorithm that alternates between sampling random effects from their conditional distribution and optimizing the fixed-effects parameters.</li><li><strong>Visualize model fit</strong> – generate fitted-trajectory plots and observation-level predictive distributions using <code>plot_fits</code> and <code>plot_observation_distributions</code>.</li><li><strong>Quantify uncertainty</strong> – compute Wald-based confidence intervals with <code>compute_uq</code> and produce publication-ready summary tables with <code>NoLimits.summarize</code>.</li></ul><h2 id="Step-1:-Data-Setup"><a class="docs-heading-anchor" href="#Step-1:-Data-Setup">Step 1: Data Setup</a><a id="Step-1:-Data-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Step-1:-Data-Setup" title="Permalink"></a></h2><p>In this step, you will load the MASS epilepsy dataset (<code>MASS::epil</code>, mirrored in Rdatasets) and reshape it into the long format that NoLimits expects, where each row represents one subject-period combination. Along the way, you will derive several analysis variables: a binary treatment indicator, log-transformed baseline seizure count and age (to stabilize the scale of the linear predictor), and a centered period variable that improves interpretability of the intercept. The treatment-by-period interaction term will allow you to test whether the treatment effect changes over the course of the trial.</p><pre><code class="language-julia hljs">using NoLimits
using CSV
using DataFrames
using Distributions
using Downloads
using LinearAlgebra
using Random
using SciMLBase

include(joinpath(@__DIR__, &quot;_data_loaders.jl&quot;))

Random.seed!(2026)

function build_epilepsy_long_df(tbl::DataFrame)
    df = DataFrame(
        Subject=Int.(tbl.subject),
        Period=Int.(tbl.period),
        Trt=string.(tbl.trt),
        Base=Int.(tbl.base),
        Age=Int.(tbl.age),
        seizures=Int.(tbl.y),
    )

    sort!(df, [:Subject, :Period])
    df.trt_active = ifelse.(df.Trt .== &quot;progabide&quot;, 1.0, 0.0)
    df.base_log = log1p.(float.(df.Base))
    df.age_log = log1p.(float.(df.Age))
    df.period_f = float.(df.Period)
    df.period_centered = df.period_f .- 1.0
    df.trt_period_centered = df.trt_active .* df.period_centered

    return df
end

epil_df = load_epil()
df = build_epilepsy_long_df(epil_df)
first(df, 10)</code></pre><h2 id="Step-2:-Poisson-Mixed-Effects-Model"><a class="docs-heading-anchor" href="#Step-2:-Poisson-Mixed-Effects-Model">Step 2: Poisson Mixed-Effects Model</a><a id="Step-2:-Poisson-Mixed-Effects-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Step-2:-Poisson-Mixed-Effects-Model" title="Permalink"></a></h2><p>In this step, you will define the Poisson mixed-effects model. The core idea is a log-linear predictor: the log of the expected seizure rate is modeled as a linear combination of covariates plus a subject-level random intercept. The random effect <code>eta</code> captures unmeasured between-subject heterogeneity in baseline seizure propensity. Because <code>eta</code> appears inside the exponential that maps the log-rate to the Poisson intensity parameter <code>lambda</code>, the model is nonlinear in the random effects – a key reason MCEM is preferred over simpler estimation methods such as the Laplace approximation.</p><p>Note the two helper functions defined in the <code>@helpers</code> block: <code>linpred</code> computes the dot product of the covariate vector with the coefficient vector (keeping the model specification clean), and <code>safe_exp</code> guards against numerical overflow in the exponential.</p><pre><code class="language-julia hljs">model_poisson = @Model begin
    @helpers begin
        safe_exp(x) = exp(clamp(x, -20.0, 20.0))
        linpred(x, β) = dot(
            [x.base_log, x.age_log, x.trt_active, x.period_centered, x.trt_period_centered],
            β,
        )
    end

    @covariates begin
        period_f = Covariate()
        x = CovariateVector([:base_log, :age_log, :trt_active, :period_centered, :trt_period_centered])
    end

    @fixedEffects begin
        beta0 = RealNumber(0.1, calculate_se=true)
        beta = RealVector([0.5, -0.1, -0.2, -0.05, -0.04], calculate_se=true)
        omega = RealNumber(0.5, scale=:log, calculate_se=true)
    end

    @randomEffects begin
        eta = RandomEffect(Normal(0.0, omega); column=:Subject)
    end

    @formulas begin
        log_rate = beta0 + linpred(x, beta) + eta
        lambda = safe_exp(log_rate)
        seizures ~ Poisson(lambda)
    end
end

NoLimits.summarize(model_poisson)</code></pre><h3 id="Build-DataModel-and-Configure-MCEM"><a class="docs-heading-anchor" href="#Build-DataModel-and-Configure-MCEM">Build <code>DataModel</code> and Configure <code>MCEM</code></a><a id="Build-DataModel-and-Configure-MCEM-1"></a><a class="docs-heading-anchor-permalink" href="#Build-DataModel-and-Configure-MCEM" title="Permalink"></a></h3><p>Next, you will bind the model to the data by constructing a <code>DataModel</code>. This step validates that all required columns are present and correctly typed, groups observations by subject, and prepares the internal data structures for estimation.</p><p>You will then configure the MCEM algorithm. The <code>sample_schedule</code> controls how many MCMC samples are drawn from the conditional distribution of the random effects at each EM iteration – starting with fewer samples and increasing over iterations improves computational efficiency. The settings here are intentionally compact for documentation purposes; in practice, you would use more iterations and larger sample sizes for production analyses.</p><pre><code class="language-julia hljs">dm_poisson = DataModel(model_poisson, df; primary_id=:Subject, time_col=:period_f)

mcem_method = NoLimits.MCEM(;
    maxiters=4,
    sample_schedule=i -&gt; min(20 + 10 * (i - 1), 60),
    turing_kwargs=(n_samples=20, n_adapt=10, progress=false),
    optim_kwargs=(maxiters=80,),
    progress=false,
)

serialization = SciMLBase.EnsembleThreads()

NoLimits.summarize(dm_poisson)</code></pre><h3 id="Fit,-Summarize,-Plot,-and-UQ-(Poisson)"><a class="docs-heading-anchor" href="#Fit,-Summarize,-Plot,-and-UQ-(Poisson)">Fit, Summarize, Plot, and UQ (Poisson)</a><a id="Fit,-Summarize,-Plot,-and-UQ-(Poisson)-1"></a><a class="docs-heading-anchor-permalink" href="#Fit,-Summarize,-Plot,-and-UQ-(Poisson)" title="Permalink"></a></h3><p>You are now ready to fit the Poisson model. The <code>fit_model</code> call runs the full MCEM loop: at each iteration, it samples random effects conditional on the current fixed-effects estimates, then updates the fixed effects by maximizing the Monte Carlo approximation to the marginal likelihood. After fitting, you will inspect a summary of the estimated parameters.</p><pre><code class="language-julia hljs">res_poisson = fit_model(
    dm_poisson,
    mcem_method;
    serialization=serialization,
    rng=Random.Xoshiro(21),
)

NoLimits.summarize(res_poisson)</code></pre><p>To assess how well the model captures individual seizure trajectories, you will now plot fitted values against observed data for the first two subjects. The observation-distribution diagnostic reveals the full predictive distribution at selected time points – a particularly informative view for count data, where the shape of the distribution (not just its mean) carries clinical significance.</p><pre><code class="language-julia hljs">p_fit_poisson = plot_fits(
    res_poisson;
    observable=:seizures,
    individuals_idx=[1, 2],
    ncols=2,
    shared_x_axis=true,
    shared_y_axis=true,
)

p_obs_poisson = plot_observation_distributions(
    res_poisson;
    observables=:seizures,
    individuals_idx=1,
    obs_rows=[1, 2],
)

p_fit_poisson</code></pre><p>Display the observation-distribution plot to examine the predicted probability mass function at individual time points.</p><pre><code class="language-julia hljs">p_obs_poisson</code></pre><p>Next, you will compute Wald-based confidence intervals for the fixed-effects parameters. The Wald method uses the curvature of the log-likelihood at the optimum to approximate the sampling distribution of each parameter estimate, yielding standard errors and 95% confidence intervals without requiring additional model fits.</p><pre><code class="language-julia hljs">uq_poisson = compute_uq(
    res_poisson;
    method=:wald,
    n_draws=100,
    level=0.95,
)

NoLimits.summarize(uq_poisson)</code></pre><p>For a consolidated view, combine the parameter estimates and their uncertainty into a single summary table – the format most convenient for reporting in manuscripts and presentations.</p><pre><code class="language-julia hljs">NoLimits.summarize(res_poisson, uq_poisson)</code></pre><p>Finally, visualize the approximate sampling distributions of the fixed-effects parameters implied by the Wald approximation.</p><pre><code class="language-julia hljs">plot_uq_distributions(uq_poisson)</code></pre><h2 id="Step-3:-Negative-Binomial-Mixed-Effects-Model"><a class="docs-heading-anchor" href="#Step-3:-Negative-Binomial-Mixed-Effects-Model">Step 3: Negative Binomial Mixed-Effects Model</a><a id="Step-3:-Negative-Binomial-Mixed-Effects-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Step-3:-Negative-Binomial-Mixed-Effects-Model" title="Permalink"></a></h2><p>The Poisson model assumes that the conditional variance of seizure counts equals the conditional mean. In practice, count data from clinical trials frequently exhibit <em>overdispersion</em> – more variability than the Poisson predicts – due to unmeasured heterogeneity beyond what the random intercept alone can capture. The Negative Binomial distribution addresses this limitation by introducing an additional dispersion parameter <code>r</code> (sometimes called the &quot;size&quot; or &quot;shape&quot; parameter). As <code>r</code> grows large, the Negative Binomial converges to the Poisson; smaller values of <code>r</code> indicate greater overdispersion. This makes the Negative Binomial a strict generalization of the Poisson, and comparing the two reveals whether overdispersion is a meaningful feature of the data.</p><p>In this step, you will define the Negative Binomial model. It retains the same structural predictor and random-effects hierarchy as the Poisson model above. The only additions are the dispersion parameter <code>log_r</code> (estimated on the log scale to ensure positivity) and the formula lines that convert the mean-scale rate <code>lambda</code> and size <code>r</code> into the <code>(r, p)</code> parameterization expected by <code>Distributions.NegativeBinomial</code>.</p><pre><code class="language-julia hljs">model_nb = @Model begin
    @helpers begin
        safe_exp(x) = exp(clamp(x, -20.0, 20.0))
        linpred(x, β) = dot(
            [x.base_log, x.age_log, x.trt_active, x.period_centered, x.trt_period_centered],
            β,
        )
    end

    @covariates begin
        period_f = Covariate()
        x = CovariateVector([:base_log, :age_log, :trt_active, :period_centered, :trt_period_centered])
    end

    @fixedEffects begin
        beta0 = RealNumber(0.1, calculate_se=true)
        beta = RealVector([0.5, -0.1, -0.2, -0.05, -0.04], calculate_se=true)
        omega = RealNumber(0.5, scale=:log, calculate_se=true)
        log_r = RealNumber(log(5.0), calculate_se=true)
    end

    @randomEffects begin
        eta = RandomEffect(Normal(0.0, omega); column=:Subject)
    end

    @formulas begin
        log_rate = beta0 + linpred(x, beta) + eta
        lambda = safe_exp(log_rate)
        r = exp(log_r) + 1e-6
        p = clamp(r / (r + lambda), 1e-8, 1.0 - 1e-8)
        seizures ~ NegativeBinomial(r, p)
    end
end

NoLimits.summarize(model_nb)</code></pre><h3 id="Build-DataModel,-Fit,-Summarize,-Plot,-and-UQ-(Negative-Binomial)"><a class="docs-heading-anchor" href="#Build-DataModel,-Fit,-Summarize,-Plot,-and-UQ-(Negative-Binomial)">Build <code>DataModel</code>, Fit, Summarize, Plot, and UQ (Negative Binomial)</a><a id="Build-DataModel,-Fit,-Summarize,-Plot,-and-UQ-(Negative-Binomial)-1"></a><a class="docs-heading-anchor-permalink" href="#Build-DataModel,-Fit,-Summarize,-Plot,-and-UQ-(Negative-Binomial)" title="Permalink"></a></h3><p>You will now follow the same workflow as for the Poisson model: construct the <code>DataModel</code>, fit with identical MCEM settings, and inspect the results. Using the same algorithm configuration for both models ensures that any differences in fit quality reflect genuine differences in model adequacy rather than tuning artifacts.</p><pre><code class="language-julia hljs">dm_nb = DataModel(model_nb, df; primary_id=:Subject, time_col=:period_f)

res_nb = fit_model(
    dm_nb,
    mcem_method;
    serialization=serialization,
    rng=Random.Xoshiro(22),
)

NoLimits.summarize(dm_nb)
NoLimits.summarize(res_nb)</code></pre><p>Generate the same fitted-trajectory and observation-distribution diagnostics as before. Comparing these plots side-by-side with the Poisson versions will reveal whether the Negative Binomial&#39;s wider predictive intervals better capture the observed variability in seizure counts.</p><pre><code class="language-julia hljs">p_fit_nb = plot_fits(
    res_nb;
    observable=:seizures,
    individuals_idx=[1, 2],
    ncols=2,
    shared_x_axis=true,
    shared_y_axis=true,
)

p_obs_nb = plot_observation_distributions(
    res_nb;
    observables=:seizures,
    individuals_idx=1,
    obs_rows=[1, 2],
)

p_fit_nb</code></pre><p>Display the Negative Binomial observation-distribution plot for direct comparison with the Poisson version above. Pay attention to the width of the predicted probability mass – the Negative Binomial should assign more probability to extreme counts.</p><pre><code class="language-julia hljs">p_obs_nb</code></pre><p>Compute Wald-based uncertainty for the Negative Binomial model and produce both standalone and combined summary tables, following the same procedure as for the Poisson fit.</p><pre><code class="language-julia hljs">uq_nb = compute_uq(
    res_nb;
    method=:wald,
    n_draws=100,
    level=0.95,
)

NoLimits.summarize(uq_nb)
NoLimits.summarize(res_nb, uq_nb)</code></pre><p>The uncertainty distribution plots for the Negative Binomial model now include the dispersion parameter <code>log_r</code> – a parameter with no counterpart in the Poisson model, whose magnitude directly quantifies the degree of overdispersion in the data.</p><pre><code class="language-julia hljs">plot_uq_distributions(uq_nb)</code></pre><h2 id="Step-4:-Comparing-Poisson-and-Negative-Binomial-Objectives"><a class="docs-heading-anchor" href="#Step-4:-Comparing-Poisson-and-Negative-Binomial-Objectives">Step 4: Comparing Poisson and Negative Binomial Objectives</a><a id="Step-4:-Comparing-Poisson-and-Negative-Binomial-Objectives-1"></a><a class="docs-heading-anchor-permalink" href="#Step-4:-Comparing-Poisson-and-Negative-Binomial-Objectives" title="Permalink"></a></h2><p>As a final diagnostic, you will compare the objective function values (negative log-likelihoods) from the two fits. A word of caution: because the Poisson is a limiting case of the Negative Binomial (as <code>r</code> tends to infinity) rather than a strict parameter restriction, these values are not directly comparable via a standard likelihood ratio test. Nevertheless, a substantially lower objective for the Negative Binomial strongly suggests that the data exhibit overdispersion the Poisson cannot accommodate. Formal model comparison for this class of count models would require information criteria (AIC, BIC) or cross-validation, which are beyond the scope of this tutorial.</p><pre><code class="language-julia hljs">(
    poisson_objective = NoLimits.get_objective(res_poisson),
    nb_objective = NoLimits.get_objective(res_nb),
)</code></pre><p>Keep in mind that these two objective values arise from different likelihood families. They provide a useful heuristic comparison, but definitive model selection requires the formal tools mentioned above.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../mixed-effects-softtree-saem/">« Mixed-Effects Tutorial 4: SoftTree Differential-Equation Components (SAEM)</a><a class="docs-footer-nextpage" href="../mixed-effects-left-censored-virload50-laplace/">Mixed-Effects Tutorial 6: Left-Censored Nonlinear Model (Laplace) »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Friday 20 February 2026 21:10">Friday 20 February 2026</span>. Using Julia version 1.12.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
